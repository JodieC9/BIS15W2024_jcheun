---
title: "Tidyr 1: Tidy data and `pivot_long()`"
date: "`r Sys.Date()`"
output:
  html_document: 
    theme: spacelab
    toc: yes
    toc_float: yes
    keep_md: yes
  pdf_document:
    toc: yes
---

> **For Big-Data Scientists, "Janitor Work" Is Key Hurdle to Insights.**  
> "Data scientists, according to interviews and expert estimates, spend from 50 percent to 80 percent of their time mired in the mundane labor of collecting and preparing data, before it can be explored for useful information."  
> [New York Times (2014)](http://www.nytimes.com/2014/08/18/technology/for-big-data-scientists-hurdle-to-insights-is-janitor-work.html)

## Learning Goals
*At the end of this exercise, you will be able to:*    
1. Explain the difference between tidy and messy data.  
2. Evaluate a data set as tidy or messy.    
3. Use the `pivot_longer()` function of `tidyr` to transform data from wide to long format.  
4. Use `separate()` to split observations within a column.  

## Overview
The quote above sums up much of the work in data science. Simply put, most of the data that you end up working with will be messy, disorganized, and not **tidy**. By the end of this week, you will have the tools necessary to wrangle messy data into tidy data that are ready for analysis. I know that we have spent a lot of time of data transformation, but this last step is essential to building plots and performing other analyses.  

## Resources  
- [tidyr `pivot_longer()`](https://tidyr.tidyverse.org/reference/pivot_longer.html)  
- [pivoting](https://cran.r-project.org/web/packages/tidyr/vignettes/pivot.html)  

## Load the tidyverse
```{r message=FALSE, warning=FALSE}
library(tidyverse)
```

## Tidy data
Most "wild" data are organized incorrectly for work in R and, as you might expect, the tools used to transform data are a core part of the tidyverse. I will attempt to summarize the most important points below, but you should read [chapter 12 of the data science text](https://r4ds.had.co.nz/tidy-data.html) for a more thorough explanation.  

`Tidy` data follows three conventions:   
(1) each variable has its own column  
(2) each observation has its own row  
(3) each value has its own cell  

But these standards are not always are collected in labs 

This is summarized in the image below. The package used to tidy data is called **tidyr** and is a core part of the tidyverse.  
![*Tidy Data.*](tidy-1.png)

## `pivot_longer()`  
Scientists frequently use spreadsheets that are organized to make data entry efficient. This is often referred to as **wide format**. Unfortunately, the wide format creates a problem because column names may actually represent values of a variable. The command `pivot_longer()` shifts data from wide to long format.   

Rules:  
+ `pivot_longer`(cols, names_to, values_to)
+ `cols` - Columns to pivot to longer format
+ `names_to` - Name of the new column; it will contain the column names of gathered columns as values
+ `values_to` - Name of the new column; it will contain the data stored in the values of gathered columns

## Example 1: column names are data
The following data show results from a drug trial with four treatments on six patients. The values represent resting heart rate.  
Note: using `read.csv` is an old way of importing data that is not always interpreting data correctly. 

```{r}
heartrate <- read_csv("data/heartrate.csv")
heartrate
```

Let's assess whether or not these data are tidy.  No this data is not tidy. 

(1) each variable has its own column?  
 Column names here are observations. 
 
(2) each observation has its own row?  

(3) each value has its own cell?  
  
To fix this problem, we need to reshape the table to long format while keeping track of column names and values. We do this using `pivot_longer()`. Notice that the dimensions of the data frame change.  
```{r}
heartrate %>% 
  pivot_longer(-patient, #patient will not move
               names_to = "drug", #make a new column called "drug"
               values_to="heartrate" #values moved to a new column called "heartrate"
               )
```
The names of the column to a new column called drug (since the a,b,c,d are observations of a data). 

## Practice
1. Import the file `relig_income.csv` and store it as a new object `relig_income`.  
```{r}
relig_income <- read_csv("data/relig_income.csv")
relig_income
```

2. Why are these data untidy?  
Untidy because the variables (column names) are actually observations of a specific religion. We need to change this data so that the single variable is "income" and each value is a specific observation. 

3. Use `pivot_longer()` to make the data tidy.  
```{r}
relig_income %>% 
  pivot_longer(-religion, #patient will not move
               names_to = "income", #make a new column called "income"
               values_to="total" #values moved to a new column called "total"
               )
```
The - means this is the column you are not moving around. Now every column is its own vairable and every row is its own observation. And every cell is a unique value. R needs every variable to have its own column, or else plotting in R will NOT work, we need an X and we need a Y. If the observations are spread across different columns (instead of rows) plots will not work 

## Example 2: some column names are data
Some (but not all) of the column names are data. We also have NA's.
```{r}
billboard <- read_csv("data/billboard.csv")
billboard
```
Fixing this data is going to make it WAY longer. 
Solution 1: specify a range of columns that you want to pivot.
```{r}
billboard2 <- 
  billboard %>% 
  pivot_longer(wk1:wk76, # a range of columns (particularly useful when data is collected across time)
               names_to = "week",
               values_to = "rank", 
               values_drop_na = TRUE #this will drop the NA's
               )
billboard2
```
Tidy. Notice that all weeks descriptions are in their own observations under a designated column. 

Solution 2: OR, specify columns that you want to stay fixed.
```{r}
billboard3 <- 
  billboard %>% 
  pivot_longer(-c(artist, track, date.entered), #specific columns to stay fixed
               names_to = "week",
               values_to = "rank",
               values_drop_na = TRUE
               )
billboard3
```
-c is another way to say DONT move these variables. 

Solution 3: identify columns by a prefix, remove the prefix and all NA's.
```{r}
billboard %>% 
   pivot_longer(
   cols = starts_with("wk"), #columns that start with "wk"
   names_to = "week",
   #names_prefix = "wk",
   values_to = "rank")
   #values_drop_na = TRUE)
```

## Practice  
1. Import `plant_data.csv` as a new object `plant_data`.  
```{r}
plant_data <- read_csv("data/plant_data.csv")
plant_data
```

2. Why are these data not tidy?  
These data are not tidy because the day observations are set as individual columns. We need to set all the days under a "time" observation 
```{r}
#plant_data %>%  
#pivot_longer(-genotype, #patient will not move
               #names_to = "income", #make a new column called "income"
               #values_to="total") #values moved to a new column called "total"
```
values_drop_na =T specifies we want to remove NA values 

3. Use `pivot_longer()` to make the data tidy. Focus the data only on genotype, water_sched_prog, and greenhouse.  
```{r}
plant_data %>% 
  pivot_longer(-c(genotype,water_sched_prog,greenhouse),
               names_to = "v1", 
               values_to = "v2",
               values_drop_na = T
               )
```
values_drop_na =T specifies we want to remove NA values when we change the data from long to wide. 

## Example 3: more than one variable in a column name
In this case, there are two observations in each column name.
```{r}
qpcr_untidy <- read_csv("data/qpcr_untidy.csv")
qpcr_untidy
```

`names_sep` helps pull these apart, but we still have "exp" and "rep" to deal with.  
```{r}
qpcr_untidy %>% 
  pivot_longer(
    exp1_rep1:exp3_rep3,
    names_to= c("experiment", "replicate"),
    names_sep="_",
    values_to="mRNA_expression"
  )
```
Using the : means you are working with a range 
names_sep specifies how the variables you are working with are separated 


Wide data is normal way to collect data for reading and presentation, but these data will NOT work with analysis in R. 

## That's it! Let's take a break and then move on to part 2!  

-->[Home](https://jmledford3115.github.io/datascibiol/)