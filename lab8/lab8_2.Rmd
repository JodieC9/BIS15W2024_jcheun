---
title: "Fun with NA's"
date: "`r Sys.Date()`"
output:
  html_document: 
    theme: spacelab
    toc: yes
    toc_float: yes
    keep_md: yes
  pdf_document:
    toc: yes
---

## Learning Goals
*At the end of this exercise, you will be able to:*    
1. Define `NA` and describe how they are treated in R.  
2. Produce summaries of the number of NA's in a data set.   
3. Replace values with `NA` in a data set as appropriate.  

```{r}
#install.packages("naniar")
```

## Load the libraries
```{r message=FALSE, warning=FALSE}
library("tidyverse")
library("naniar")
library("skimr")
library("janitor")
```

## Review
When working with "wild" data, dealing with NA's is a fundamental part of the data cleaning process. Data scientists spend most of their time cleaning and transforming data- including managing NA's. There isn't a single approach that will always work so you need to be careful about using replacement strategies across an entire data set. And, as the data sets become larger NA's can become trickier to deal with.  

For the following, we will use life history data for mammals. The [data](http://esapubs.org/archive/ecol/E084/093/) are from:  
**S. K. Morgan Ernest. 2003. Life history characteristics of placental non-volant mammals. Ecology 84:3402.**  

## Load the mammals life history data and clean the names  
```{r}
life_history <- read_csv("data/mammal_lifehistories_v3.csv") %>% clean_names()
```

## Are there any NA's?
Sometimes using one or more of the summary functions can give us clues to how the authors have represented missing data. This doesn't always work, but it is a good place to start.
```{r}
glimpse(life_history)
```

```{r}
summary(life_history)
```

Seeing negative values for categories that do not make sense is a red flag of NA values written as something non 'NA'. 

Here is a new one for you using the `purrr` package. This will give you a quick summary of the number of NA's in each variable.
```{r}
life_history %>% 
  map_df(~ sum(is.na(.)))
```
 This function tells us where all the NAs are in the data frame. It sees 0 in this function bc R will not see -999 as a NA value 
## Practice
1. Can we use a single approach to deal with NA's in this data set? Given what you learned in the previous lab, how would you manage the NA values?
```{r}
names(life_history)
```


```{r}
life_history <- life_history <- read_csv("data/mammal_lifehistories_v3.csv",na=c("NA"," ",".","-999","-999.00","not measured")) %>% clean_names()
life_history %>% 
  map_df(~ sum(is.na(.)))
```
na =c(list of all the things we want R to consider NA in the dataset). Now, since we have assigned the `real` NA values, the map_df command will count the NA in the data. To use this method you HAVE to know all the ways NA values are alternatively represented in the data. You do not want to do this method by default.

## `naniar`
`naniar` is a package that is built to manage NA's. Many of the functions it performs can also be performed using tidyverse functions, but it does provide some interesting alternatives.  

`miss_var_summary` provides a clean summary of NA's across the data frame.
```{r}
naniar::miss_var_summary(life_history)
```

From the naniar program, provide a missing variable summary from the lift history data 


Notice that `max_life` has no NA's. Does that make sense in the context of this data? No, it does not make sense for 0 to be the max life value. Hints that 0 in this context is being used as a NA substitution. 
```{r}
hist(life_history$max_life)
```

Let's use `mutate()` and `na_if()` to replace 0's with NA's in `max_life`.
```{r}
life_history <- 
  life_history %>% 
  mutate(max_life=na_if(max_life, 0))
```

```{r}
miss_var_summary(life_history)
```
`pct_miss` the percent of missing values in that vairable. 

We can also use `miss_var_summary` with `group_by()`. This helps us better evaluate where NA's are in the data.
```{r}
life_history %>%
  group_by(order) %>%
  select(order, wean_mass) %>% 
  miss_var_summary(order=T)
```

`naniar` also has a nice replace function which will allow you to precisely control which values you want replaced with NA's in each variable.
```{r}
life_history %>% 
  replace_with_na(replace = list(newborn = "not measured", 
                                 weaning= -999, 
                                 wean_mass= -999, 
                                 afr= -999, 
                                 max_life= 0, 
                                 litter_size= -999, 
                                 gestation= -999, 
                                 mass= -999)) %>% 
miss_var_summary()
```
Specifically replacing the unique ways that NA may be represented in each of the varirables. AKA, this command makes replacement of NAs specific to a variable. 

## Practice
Let's practice evaluating NA's in a large data set. The data are compiled from [CITES](https://cites.org/eng). This is the international organization that tracks trade in endangered wildlife. You can find information about the data [here](https://www.kaggle.com/cites/cites-wildlife-trade-database).  

Some key information:  
[country codes](https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2)  

1. Import the data and do a little exploration. Be sure to clean the names if necessary.
```{r}
cities <- read_csv("data/cites.csv")
cities <- clean_names(cities)
```

2. Use `naniar` to summarize the NA's in each variable.
```{r}
miss_var_summary(cities) ##snapshot of where the NAs are in the data. 
```

3. Try using `group_by()` with `naniar`. Look specifically at class and `exporter_reported_quantity`. For which taxonomic classes do we have a high proportion of missing export data?

```{r}
names(cities)
```


```{r}
cities %>% 
  select(class,exporter_reported_quantity) %>% #optional, pulls out the variables you want to work with 
  group_by(class) %>%
  miss_var_summary() %>% 
  arrange(desc(pct_miss))
```



## Visualizing NAs
There is another package `visdat` that can be used to visualize the proportion of different classes of data, including missing data. But, it is limited by size.
```{r}
library(visdat)
```

```{r}
vis_dat(life_history) #classes of data
```
For large data, output of which variables have large amounts of missing data. 

```{r}
vis_miss(life_history)
```
Here, we are just looking at the missing data. 

## Dealing with NA's in advance
If you are sure that you know how NA's are treated in the data, then you can deal with them in advance using `na()` as part of the `readr` package.
```{r}
life_history_advance <- 
  readr::read_csv(file = "data/mammal_lifehistories_v3.csv", 
                  na = c("NA", " ", ".", "-999")) #all NA, blank spaces, .,and -999 are treated as NA
```

```{r}
miss_var_summary(life_history_advance)
```

## Wrap-up  
Please review the learning goals and be sure to use the code here as a reference when completing the homework.

-->[Home](https://jmledford3115.github.io/datascibiol/)